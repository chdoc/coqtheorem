\ProvidesPackage{coqtheorem}
\RequirePackage{xparse}
\RequirePackage{hyperref}
\RequirePackage{mfirstuc}

\newcommand{\setCoqFilename}[1]{\def\filename{#1}}
\newcommand{\setBaseUrl}[1]{\def\baseurl#1}
\setBaseUrl{}
\setCoqFilename{}
\def\theoremname{}
\def\showname{}
\def\theoremtype{}

\newcommand{\coqlink}[2][]{\href{\baseurl\filename.html\##1}{#2}}

\@ifpackageloaded{paralist}{%
  \newcommand{\coqitem}[1][]{\stepcounter{enumi}\item[{\coqlink[#1]{\labelenumi}}]}
}{%
  \newcommand{\coqitem}[1][]{\stepcounter{enumi}\item[{\coqlink[#1]{\theenumi.}}]}
}%

\@ifclassloaded{llncs}{
  % If the class is LLNCS:
  \let\theorem\relax
  \let\lemma\relax
  \let\definition\relax
  \let\fact\relax
  \let\corollary\relax

  \spnewtheorem{dummy}{}{}{}

  \newcommand{\genFancyTheoremEnvironment}[1]{%
    \spnewtheorem{#1Aux}[dummy]{}{\bfseries\theoremtype}{{\bfseries\showname}\itshape}
    \spnewtheorem{#1AuxCoq}[dummy]{}{\bfseries \coqlink[\theoremname]{\theoremtype}}{{\bfseries\showname}\itshape\label{coq:\theoremname}}
    \NewDocumentEnvironment{#1}{oo}%
    {%
      \IfValueT{##1}{\ifx&##1&%
          \else\def\showname{\hspace{-0.6em} (##1)~}\fi}%
      \def\theoremtype{\capitalisewords{#1}}%
      \IfValueTF{##2}{\def\theoremname{##2}\begin{#1AuxCoq}}{\begin{#1Aux}}%
    }%
    {\IfValueTF{##2}{\end{#1AuxCoq}}{\end{#1Aux}}\def\theoremname{}\def\showname{}}}

  \genFancyTheoremEnvironment{theorem}
  \genFancyTheoremEnvironment{lemma}
  \genFancyTheoremEnvironment{definition}
  \genFancyTheoremEnvironment{fact}
  \genFancyTheoremEnvironment{corollary}
}{
  % If not LLNCS

  \RequirePackage{ntheorem}

  \newtheoremstyle{coqtheorem}
  {\linkableTheoremAux{##1}{##2}}
  {\linkableTheoremAux{##1}{##2}[##3]}
  \NewDocumentCommand\linkableTheoremAux{mmou\ignorespaces o}
  {\item[\hskip\labelsep \theorem@headerfont
    \IfValueTF{#5}{\coqlink[#5]{#1\
        #2\IfValueT{#3}{\ifx&#3&%
          \else\ (#3)\fi}{}}}{#1\ #2 \IfValueT{#3}{\ (#3)}{}}
    \theorem@separator]#4\ignorespaces\IfValueT{#5}{\label{coq:#5}}}
}
